<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerador de HTMLs</title>
</head>
<body>
  <h1>Gerador de formulários</h1>

  <form id="form">
    <input id="Nome" placeholder="Nome">
    <input id="SIAPE" placeholder="SIAPE">
    <input id="Cargo" placeholder="Cargo">
    <input id="Telefone" placeholder="Telefone">
    <input id="email" placeholder="Email">
    <input id="InstituicaoDestino" placeholder="Instituição destino">
    <input id="Evento" placeholder="Evento">
    <input id="CidadeDestino" placeholder="Cidade destino">
    <input id="EstadoDestino" placeholder="Estado destino">
    <input id="DataInicioEvento" placeholder="Data início evento">
    <input id="DataTerminoEvento" placeholder="Data término evento">
    <input id="DataInicioAfastamento" placeholder="Data início afastamento">
    <input id="DataTerminoAfastamento" placeholder="Data término afastamento">
    
    <!-- Natureza e Tipo seriam selects -->
    <select id="NaturezaAfastamento">
      <option value="CASO_1">CASO_1</option>
      <option value="CASO_2">CASO_2</option>
      <option value="CASO_3">CASO_3</option>
    </select>
    
    <select id="TipoAfastamento">
      <option value="TIPO_1">TIPO_1</option>
      <option value="TIPO_2">TIPO_2</option>
      <option value="TIPO_3">TIPO_3</option>
    </select>

    <input id="NomeFinanciador" placeholder="NomeFinanciador">
    <input id="DataDaSolicitacaoSEI" placeholder="DataDaSolicitacaoSEI">
    
    <button type="submit">Gerar arquivos</button>
  </form>

  <p id="status"></p>

  <script>

// Convert string to ISO-8859-1 bytes manually
function latin1Bytes(str) {
  const arr = new Uint8Array(str.length);
  for (let i = 0; i < str.length; i++) {
    const code = str.charCodeAt(i);
    if (code > 255) {
      throw new Error("Character cannot be represented in ISO-8859-1: " + str[i]);
    }
    arr[i] = code;
  }
  return arr;
}

function replaceBytes(arr, fromStr, toStr) {
  //const from = new TextEncoder("latin1").encode(fromStr); // fromStr as bytes
  //const to = new TextEncoder("latin1").encode(toStr);
  const from = latin1Bytes(fromStr);
  const to = latin1Bytes(toStr);

  const result = new Uint8Array(arr.length - from.length + to.length);
  let ri = 0;

  for (let i = 0; i < arr.length;) {
    let match = true;
    for (let j = 0; j < from.length; j++) {
      if (arr[i + j] !== from[j]) {
        match = false;
        break;
      }
    }

    if (match) {
      result.set(to, ri);
      i += from.length;
      ri += to.length;
    } else {
      result[ri++] = arr[i++];
    }
  }

  return result.buffer;
}

  const templates = ["oform-1.htm", "oform-2.htm", "oform-3.htm", "oform-4.htm"];

document.getElementById("form").addEventListener("submit", async (e) => {
  e.preventDefault();
  document.getElementById("status").innerText = "Processando...";

  // === 1. Coleta os dados do formulário ===
  const Nome   = document.getElementById("Nome").value;
  const SIAPE  = document.getElementById("SIAPE").value;
  const Cargo  = document.getElementById("Cargo").value;
  const Email  = document.getElementById("email").value;
  const Tel    = document.getElementById("Telefone").value;
  const Evento = document.getElementById("Evento").value;

  // selects
  const Natureza = document.getElementById("NaturezaAfastamento").value;
  const Tipo     = document.getElementById("TipoAfastamento").value;

  // === 2. Monta os mapeadores (igual Python) ===
  const mapeador1 = {
    "chave_01": Nome,
    "chave_02": SIAPE,
    "chave_03": Cargo,
    "chave_04": Tel,
    "chave_05": Email,
    "chave_06": document.getElementById("InstituicaoDestino").value,
    "chave_21": Evento,
    "chave_07": document.getElementById("CidadeDestino").value,
    "chave_08": document.getElementById("EstadoDestino").value,
    "chave_09": document.getElementById("DataInicioEvento").value,
    "chave_10": document.getElementById("DataTerminoEvento").value,
    "chave_11": document.getElementById("DataInicioAfastamento").value,
    "chave_12": document.getElementById("DataTerminoAfastamento").value,
    // inicializações
    "chave_13": "", "chave_14": "", "chave_15": "",
    "chave_16": "", "chave_17": "",
    "chave_18": "[digite aqui ... UFF]",
    "chave_19": "[digite aqui ... agência federal]",
    "chave_20": "[digite aqui ... agência não federal]",
    "chave_tipo_1": "", "chave_tipo_2": "", "chave_tipo_3": "",
    "chave_tipo_4": "", "chave_tipo_5": "", "chave_tipo_6": "",
    "chave_tipo_7": "", "chave_tipo_8": "", "chave_tipo_9": "",
    "chave_22": ""
  };

  // aplica lógica igual Python
  if (Natureza === "CASO_1") {
    mapeador1["chave_13"] = "X";
    mapeador1["chave_18"] = document.getElementById("NomeFinanciador").value;
  } else if (Natureza === "CASO_2") {
    mapeador1["chave_14"] = "X";
    mapeador1["chave_19"] = document.getElementById("NomeFinanciador").value;
  }

  if (Tipo === "TIPO_1") mapeador1["chave_tipo_1"] = "X";
  else if (Tipo === "TIPO_2") mapeador1["chave_tipo_2"] = "X";
  else if (Tipo === "TIPO_8") {
    mapeador1["chave_tipo_8"] = "X";
    mapeador1["chave_22"] = document.getElementById("OutroTipo").value;
  }

  // outros mapeadores (2,3,4)
  const mapeador2 = { "chave_01": Nome, "chave_02": SIAPE };
  const mapeador3 = { "chave_01": document.getElementById("DataDaSolicitacaoSEI").value, "chave_02": Nome };
  const mapeador4 = { "chave_01": Nome, "chave_02": SIAPE, "chave_03": Cargo };

  const omapeador = [mapeador1, mapeador2, mapeador3, mapeador4];
  const templates = ["oform-1.htm","oform-2.htm","oform-3.htm","oform-4.htm"];
  const outputs   = ["nform-1.htm","nform-2.htm","nform-3.htm","nform-4.htm"];

  // === 3. Processa os templates ===
  for (let i = 0; i < templates.length; i++) {
    try {
        console.log("loading "+templates[i]);

        /*
      const res = await fetch(templates[i]);
      let html = await res.text();

      // substitui todas as chaves do mapeador correspondente
      for (const [key, value] of Object.entries(omapeador[i])) {
        html = html.replaceAll(key, value ?? "");
      }

      */
      const res = await fetch(templates[i]);
      let arrayBuffer = await res.arrayBuffer();
      const decoder = new TextDecoder("iso-8859-1");
      // const html = decoder.decode(arrayBuffer);
      let html = decoder.decode(arrayBuffer);
      // create a typed array view over the ArrayBuffer
const bytes = new Uint8Array(arrayBuffer);

// log the first 50 bytes
console.log(bytes.slice(0, 50));

      // gera download
      /*
      const blob = new Blob([html], { type: "text/html" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = outputs[i];
      a.click();
      URL.revokeObjectURL(url);
      */

      // html = html.replace(/chave_01/g, "My Page");

      const map1 = {
  "chave_01": document.getElementById("Nome").value,
  "chave_02": document.getElementById("SIAPE").value,
  /*
  "chave_03": document.getElementById("Cargo").value,
  "chave_04": document.getElementById("Telefone").value,
  "chave_05": document.getElementById("email").value,
  "chave_06": document.getElementById("InstituicaoDestino").value,
  "chave_07": document.getElementById("CidadeDestino").value,
  "chave_08": document.getElementById("EstadoDestino").value,
  "chave_09": document.getElementById("DataInicioEvento").value,
  "chave_10": document.getElementById("DataTerminoEvento").value,
  "chave_11": document.getElementById("DataInicioAfastamento").value,
  "chave_12": document.getElementById("DataTerminoAfastamento").value,
  "chave_21": document.getElementById("Evento").value
  */
};

for (const [key, value] of Object.entries(map1)) {
  arrayBuffer = replaceBytes(new Uint8Array(arrayBuffer), key, value);
}

      /*
      arrayBuffer = replaceBytes(
        new Uint8Array(arrayBuffer),
        "chave_01",
        document.getElementById("Nome").value
      );
      */

const blob = new Blob([arrayBuffer], { type: "text/html" });
const url = URL.createObjectURL(blob);
const a = document.createElement("a");
a.href = url;
a.download = outputs[i];
a.click();
URL.revokeObjectURL(url);

    } catch (err) {
      console.error("Erro ao processar " + templates[i], err);
    }
  }

  document.getElementById("status").innerText = "Arquivos gerados!";
});

  </script>
</body>
</html>
